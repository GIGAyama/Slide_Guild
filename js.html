<script>
  // èµ·å‹•ç¢ºèªãƒ­ã‚°
  console.log("Slide Guild App Loaded");

  // ã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¯GASã‹ã‚‰å–å¾—ã™ã‚‹ã‚ˆã†ã«ãªã£ãŸãŸã‚å‰Šé™¤


  // ç”»é¢ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
  document.addEventListener('DOMContentLoaded', function () {
    renderQuests();
  });

  // ç”»é¢åˆ‡ã‚Šæ›¿ãˆé–¢æ•° (ä¿®æ­£: elã‚’å—ã‘å–ã‚‹)
  function switchView(el, viewId) {
    // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‹ã‚‰activeã‚’å¤–ã™
    var navs = document.querySelectorAll('.nav-link');
    for (var i = 0; i < navs.length; i++) {
      navs[i].classList.remove('active');
    }

    // æŠ¼ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã«activeã‚’ã¤ã‘ã‚‹
    if (el) {
      el.classList.add('active');
    }

    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
    var sections = document.querySelectorAll('.view-section');
    for (var k = 0; k < sections.length; k++) {
      sections[k].classList.add('d-none');
    }

    var target = document.getElementById(viewId);
    if (target) {
      target.classList.remove('d-none');
    }

    // ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãªã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
    if (viewId === 'gallery-view') {
      loadGallery();
    }
  }

  // ã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§æç”»
  // ã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§æç”»
  function renderQuests() {
    var container = document.getElementById('quest-list');

    // ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚¹ã‚¯ãƒªãƒ¼ãƒ³
    container.innerHTML = `
      <div class="text-center py-5 text-muted">
        <div class="spinner-grow text-warning" role="status"></div>
        <p class="mt-2 text-muted small">å†’é™ºã®æ›¸ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
      </div>
    `;

    // Parallel Fetch: Quests and User Profile
    // Using Promise.all pattern with google.script.run is hard, so fetch profile first then quests
    runGoogleScript('getUserProfile', [], function (profile) {
      console.log("Profile:", profile);
      // Update User Info Header (if element exists)
      updateHeaderProfile(profile);

      runGoogleScript('getQuestData', [], function (quests) {
        if (!quests || quests.length === 0) {
          container.innerHTML = `
            <div class="alert alert-warning text-center" role="alert">
              ã‚¯ã‚¨ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚<br>å…ˆç”Ÿã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚
            </div>
          `;
          return;
        }

        var html = '';
        quests.forEach(function (q) {
          const isCleared = profile && profile.clearedQuests && profile.clearedQuests.includes(q.id);
          const cardClass = isCleared ? 'border-success bg-light' : 'quest-card-interactive';
          const badge = isCleared ? '<span class="badge bg-success position-absolute top-0 start-100 translate-middle p-2 border border-light rounded-circle"><span class="visually-hidden">Clear</span>ğŸ†</span>' : '';

          // Store raw quest data for modal access
          // We can attach it to the DOM or keep in memory. Let's keep in memory map if easy, or just use JSON in data attr.
          // Using data attribute for simplicity of statelessness.
          const safeTitle = q.title.replace(/"/g, '&quot;');
          const safeDesc = q.description.replace(/"/g, '&quot;');

          html += `<div class="card mb-3 level-${q.level} ${cardClass} position-relative" 
                       onclick="openQuestDetail('${q.id}', '${safeTitle}', '${safeDesc}', ${q.level}, '${q.demoSlideId || ''}', ${isCleared})">`;
          html += badge;
          html += '  <div class="card-body">';
          html += '    <h6 class="card-title fw-bold">';
          html += '      <span class="badge bg-secondary me-2 rounded-pill">Lv.' + q.level + '</span>';
          html += applyRuby(q.title);
          html += '    </h6>';
          html += '    <p class="card-text small text-muted mb-0 text-truncate">' + applyRuby(q.description) + '</p>'; // Truncate desc in card
          if (isCleared) {
            html += '<div class="mt-2 text-success small fw-bold"><i class="bi bi-check-circle-fill"></i> ã‚¯ãƒªã‚¢æ¸ˆã¿</div>';
          } else {
            html += '<div class="mt-2 text-primary small"><i class="bi bi-cursor"></i> ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ã‚’è¦‹ã‚‹</div>';
          }
          html += '  </div>';
          html += '</div>';
        });

        container.innerHTML = html;
      });
    });
  }

  // ã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  function openQuestDetail(id, title, desc, level, demoSlideId, isCleared) {
    document.getElementById('quest-detail-title').textContent = title;
    document.getElementById('quest-detail-desc').innerHTML = applyRuby(desc);
    document.getElementById('quest-detail-level').textContent = 'Lv.' + level;

    // Slide Embed
    const slideContainer = document.getElementById('quest-detail-slide-container');
    if (demoSlideId && demoSlideId !== 'undefined' && demoSlideId !== 'null') {
      const embedUrl = 'https://docs.google.com/presentation/d/' + demoSlideId + '/embed?start=false&loop=false&delayms=3000';
      slideContainer.innerHTML = '<iframe src="' + embedUrl + '" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true" class="w-100 h-100 border-0"></iframe>';
    } else {
      slideContainer.innerHTML = '<div class="position-absolute top-50 start-50 translate-middle text-center text-muted">' +
        '<i class="bi bi-file-earmark-slides" style="font-size: 3rem;"></i><br>' +
        'ã‚¬ã‚¤ãƒ‰ã‚¹ãƒ©ã‚¤ãƒ‰ãªã—' +
        '</div>';
    }

    // Actions
    const actionsDiv = document.getElementById('quest-detail-actions');
    if (isCleared) {
      actionsDiv.innerHTML = '<button class="btn btn-outline-success btn-lg rounded-pill" disabled>' +
        '<i class="bi bi-check-circle-fill"></i> ã‚¯ãƒªã‚¢æ¸ˆã¿ï¼' +
        '</button>';
    } else {
      actionsDiv.innerHTML = '<button class="btn btn-quest btn-lg w-100 rounded-pill py-3 fw-bold shadow-sm" onclick="submitQuest(\'' + id + '\', \'' + title + '\')">' +
        '<i class="bi bi-send-fill"></i> <ruby>æå‡º<rt>ã¦ã„ã—ã‚…ã¤</rt></ruby>ã™ã‚‹' +
        '</button>';
    }

    const modal = new bootstrap.Modal(document.getElementById('questDetailModal'));
    modal.show();
  }

  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–° (ãƒ˜ãƒƒãƒ€ãƒ¼)
  function updateHeaderProfile(profile) {
    if (!profile) return;
    document.getElementById('user-level-badge').textContent = profile.level;
    document.getElementById('user-level').textContent = profile.level;
    document.getElementById('user-xp').textContent = `(${profile.xp} XP)`;

    // XP Progress (Assuming 100 XP per level for simplicity)
    const currentLevelXp = profile.xp % 100;
    document.getElementById('xp-progress').style.width = currentLevelXp + '%';
  }

  // ãƒ«ãƒ“æŒ¯ã‚Šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  function applyRuby(text) {
    if (!text) return '';
    if (text.includes('<') && text.includes('>')) return text;
    return text.replace(/([\u4E00-\u9FFF]+)\(([ã-ã‚“ã‚¡-ãƒ³]+)\)/g, '<ruby>$1<rt>$2</rt></ruby>');
  }

  // ã‚¯ã‚¨ã‚¹ãƒˆæå‡º (Submit)
  function submitQuest(questId, questTitle) {
    // 1. UI Feedback: Disable button & Show Spinner
    // Find the button that was clicked. Since we don't pass 'this', we find by questId or just use SweetAlert loader.
    // Better: Update RenderQuests to pass 'this' or use a unique ID.
    // For now, let's use SweetAlert's loading state which blocks interaction effectively.

    Swal.fire({
      title: 'æå‡ºä¸­...',
      text: 'ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æå‡ºã—ã¦ã„ã¾ã™ã€‚\nãã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„ã€‚',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    // 2. Call GAS
    google.script.run
      .withSuccessHandler(function (result) {
        Swal.close(); // Close loader
        Swal.fire({
          title: 'æå‡ºå®Œäº†ï¼',
          text: 'ã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã‹ï¼Ÿ\nï¼ˆâ€»åæ˜ ã¾ã§å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼‰',
          icon: 'success',
          timer: 3000,
          showConfirmButton: false
        });
        // ç”»é¢ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åæ˜ ï¼ˆClearedãƒãƒƒã‚¸ãªã©ã‚’æ›´æ–°ï¼‰
        setTimeout(function () {
          // Reload Quest View
          document.querySelector('button[onclick*="quest-view"]').click();
          // loadGallery(); // Optional
        }, 3000);
      })
      .withFailureHandler(function (e) {
        Swal.close();
        Swal.fire('ã‚¨ãƒ©ãƒ¼', 'æå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error');
      })
      .submitSlide(questId, questTitle);
  }

  // ã‚®ãƒ£ãƒ©ãƒªãƒ¼èª­ã¿è¾¼ã¿ (v2.6)
  function loadGallery() {
    const container = document.getElementById('gallery-list');
    const filter = document.getElementById('gallery-filter') ? document.getElementById('gallery-filter').value : 'all';

    container.innerHTML = `
      <div class="col-12 text-center py-5">
        <div class="spinner-border text-warning" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    `;

    runGoogleScript('getGalleryData', [filter], function (jsonString) {
      console.log("Raw JSON received:", jsonString);

      let data = [];
      try {
        data = JSON.parse(jsonString);
      } catch (e) {
        console.error("JSON parse error", e);
      }

      // Check data integrity
      if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = `
          <div class="col-12 text-center text-muted py-5">
            <i class="bi bi-inbox" style="font-size: 2rem;"></i><br>
            æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“
          </div>
        `;
        return;
      }

      let html = '';
      data.forEach(function (item) {
        // Thumbnail URL handling
        let thumbSrc = item.thumbnailUrl;

        // Date formatting based on input format
        let dateStr = 'No Date';
        try {
          if (item.timestamp) {
            let d = new Date(item.timestamp);
            if (!isNaN(d.getTime())) {
              dateStr = d.toLocaleDateString('ja-JP');
            } else {
              dateStr = String(item.timestamp);
            }
          }
        } catch (e) { }

        // Review Logic variables
        const approvals = item.approvals || 0;
        const status = item.status || 'pending';
        const isMine = item.isMine;
        const hasReviewed = item.hasReviewed;

        let progressPercent = Math.min((approvals / 5) * 100, 100);
        let progressColor = status === 'approved' ? 'bg-success' : 'bg-warning';
        let statusBadge = status === 'approved' ? '<span class="badge bg-success mb-2">ğŸ† ã‚¯ãƒªã‚¢ï¼</span>' : '';
        if (isMine) statusBadge += ' <span class="badge bg-primary mb-2 ms-1">ã‚ãªãŸ</span>';

        html += '<div class="col-12 col-md-6">';
        html += '  <div class="card gallery-card h-100 border-0 shadow-sm">';
        html += '    <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center pb-0">';
        html += '      <span class="badge bg-light text-secondary border"><i class="bi bi-clock"></i> ' + dateStr + '</span>';
        html += statusBadge;
        html += '    </div>';

        html += '    <div class="card-body">';
        html += '      <div class="slide-container rounded shadow-sm mb-3" onclick="openGalleryModal(\'' + item.embedUrl + '\', \'' + thumbSrc + '\')" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¦‹ã‚‹">';
        html += '        <img src="' + thumbSrc + '" alt="slide thumbnail" class="rounded">';
        html += '        <div class="play-icon-overlay"><i class="bi bi-play-circle-fill"></i></div>';
        html += '      </div>';

        html += '      <div class="d-flex justify-content-between align-items-start mb-2">';
        html += '         <small class="fw-bold text-truncate text-dark" style="max-width: 60%;">' + item.title + '</small>';
        html += '         <small class="text-muted" style="font-size:0.75rem;">' + item.userId.split('@')[0] + '</small>';
        html += '      </div>';
        html += '      <div class="progress mb-3" style="height: 10px;">';
        html += '        <div class="progress-bar ' + progressColor + ' progress-bar-striped progress-bar-animated" role="progressbar" style="width: ' + progressPercent + '%"></div>';
        html += '      </div>';

        // Action Buttons Logic
        if (status === 'approved') {
          html += '     <div class="text-center text-success fw-bold small"><i class="bi bi-stars"></i> ã‚¯ã‚¨ã‚¹ãƒˆãƒ»ã‚¯ãƒªã‚¢ï¼</div>';
        } else if (isMine) {
          html += '     <div class="d-grid"><button class="btn btn-light btn-sm text-muted" disabled>è‡ªåˆ†ã®ä½œå“ã§ã™</button></div>';
        } else if (hasReviewed) {
          html += '     <div class="d-grid"><button class="btn btn-outline-secondary btn-sm" disabled><i class="bi bi-check2"></i> è©•ä¾¡æ¸ˆã¿</button></div>';
        } else {
          html += '      <div class="d-flex justify-content-between gap-2">';
          html += '        <button class="btn btn-outline-danger flex-grow-1 btn-sm rounded-pill" onclick="sendReview(this, ' + item.rowIndex + ', false)">';
          html += '          <i class="bi bi-x-circle"></i> ã‚‚ã†å°‘ã—...';
          html += '        </button>';
          html += '        <button class="btn btn-outline-success flex-grow-1 btn-sm rounded-pill" onclick="sendReview(this, ' + item.rowIndex + ', true)">';
          html += '          <i class="bi bi-check-circle"></i> åˆæ ¼ï¼';
          html += '        </button>';
          html += '      </div>';
        }
        html += '    </div>';
        html += '  </div>';
        html += '</div>';
      });

      container.innerHTML = html;
    });
  }

  // ãƒã‚¤ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿
  function loadMyPage() {
    runGoogleScript('getUserProfile', [], function (profile) {
      if (!profile) return;
      updateHeaderProfile(profile);

      document.getElementById('mypage-level').textContent = profile.level;
      document.getElementById('mypage-user-id').textContent = profile.userId.split('@')[0];
      document.getElementById('mypage-xp').textContent = profile.xp;

      const currentLevelXp = profile.xp % 100;
      document.getElementById('mypage-progress').style.width = currentLevelXp + '%';
      document.getElementById('mypage-next-xp').textContent = 100 - currentLevelXp;

      const list = document.getElementById('mypage-cleared-list');
      if (profile.clearedQuests && profile.clearedQuests.length > 0) {
        runGoogleScript('getQuestData', [], function (quests) {
          let html = '';
          const questMap = {};
          quests.forEach(q => questMap[q.id] = q.title);

          profile.clearedQuests.forEach(qid => {
            const title = questMap[qid] || 'Unknown Quest';
            html += `<li class="list-group-item"><i class="bi bi-check-circle-fill text-success"></i> ${title}</li>`;
          });
          list.innerHTML = html;
        });
      } else {
        list.innerHTML = '<li class="list-group-item text-muted text-center py-4">ã¾ã ã‚¯ãƒªã‚¢ã—ã¦ã„ã¾ã›ã‚“</li>';
      }
    });
  }

  // å…ˆç”Ÿãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (Password Protected)
  let teacherPassword = '';

  function openTeacherDashboard() {
    Swal.fire({
      title: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›',
      input: 'password',
      inputAttributes: {
        autocapitalize: 'off'
      },
      showCancelButton: true,
      confirmButtonText: 'ãƒ­ã‚°ã‚¤ãƒ³',
      showLoaderOnConfirm: true,
      preConfirm: (pass) => {
        return new Promise((resolve, reject) => {
          // Validate password by trying to fetch data
          runGoogleScript('getTeacherDashboardData', [pass], function (jsonString) {
            console.log("Dashboard response:", jsonString);
            let data = null;
            try {
              data = JSON.parse(jsonString);
            } catch (e) {
              console.error("JSON Parse Error", e);
            }

            if (data) {
              teacherPassword = pass; // Store for valid session
              resolve(data);
            } else {
              reject(new Error('èªè¨¼å¤±æ•—: ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼'));
            }
          }, function (e) {
            Swal.showValidationMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™: ' + e.message);
            resolve(false); // Stay in modal
          });
        });
      },
      allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
      if (result.isConfirmed && result.value) {
        const data = result.value;
        const modal = new bootstrap.Modal(document.getElementById('teacherModal'));
        modal.show();

        const tbody = document.getElementById('teacher-student-list');
        let html = '';
        if (data.students) {
          data.students.forEach(s => {
            const emailLocal = s.email ? s.email.split('@')[0] : 'Unknown';
            html += `<tr>
                   <td>${emailLocal}</td>
                   <td><span class="badge bg-warning text-dark">${s.level}</span></td>
                   <td>${s.xp}</td>
                   <td>${s.clearedCount}</td>
                   <td>${s.lastActive}</td>
                 </tr>`;
          });
        }
        tbody.innerHTML = html;
      }
    });
  }

  // ã‚¯ã‚¨ã‚¹ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  function importQuests() {
    const jsonStr = document.getElementById('quest-json-input').value;
    if (!jsonStr) return;

    if (!teacherPassword) {
      Swal.fire('ã‚¨ãƒ©ãƒ¼', 'å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„', 'error');
      return;
    }

    runGoogleScript('saveQuestData', [jsonStr, teacherPassword], function (res) {
      alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ: ' + res.count + 'ä»¶');
    });
  }

  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
  function changePassword() {
    const newPass = document.getElementById('new-password').value;
    if (!newPass) return;

    if (!teacherPassword) {
      Swal.fire('ã‚¨ãƒ©ãƒ¼', 'å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„', 'error');
      return;
    }

    runGoogleScript('changeTeacherPassword', [teacherPassword, newPass], function (res) {
      if (res.success) {
        teacherPassword = newPass; // Update memory
        Swal.fire('æˆåŠŸ', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚æ¬¡å›ã‹ã‚‰æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚', 'success');
        document.getElementById('new-password').value = '';
      }
    }, function (e) {
      Swal.fire('ã‚¨ãƒ©ãƒ¼', e.message, 'error');
    });
  }

  // ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã (ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ + å†ç”Ÿãƒœã‚¿ãƒ³)
  function openGalleryModal(embedUrl, thumbSrc) {
    var modalBody = document.querySelector('#galleryModal .modal-body');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸­èº«ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆç”»åƒè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‰
    // å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ iframe ã«æ›¸ãæ›ã‚ã‚‹
    var contentHtml = `
      <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-2 z-3" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="ratio ratio-16x9 shadow-lg rounded overflow-hidden bg-black position-relative" id="gallery-view-area">
        <img src="${thumbSrc}" class="w-100 h-100 object-fit-contain" alt="Preview">
        <div class="position-absolute top-50 start-50 translate-middle">
          <button class="btn btn-warning btn-lg rounded-pill fw-bold shadow-lg" onclick="playSlide('${embedUrl}')">
            <i class="bi bi-play-fill"></i> ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å†ç”Ÿ
          </button>
        </div>
      </div>
      <div class="text-center mt-3">
        <button class="btn btn-light rounded-pill fw-bold" data-bs-dismiss="modal">
           <i class="bi bi-x-circle"></i> é–‰ã˜ã‚‹
        </button>
      </div>
    `;

    modalBody.innerHTML = contentHtml;

    var myModal = new bootstrap.Modal(document.getElementById('galleryModal'));
    myModal.show();
  }

  // ã‚¹ãƒ©ã‚¤ãƒ‰å†ç”Ÿï¼ˆiframeã«ç½®ãæ›ãˆï¼‰
  function playSlide(url) {
    var viewArea = document.getElementById('gallery-view-area');
    viewArea.innerHTML = `<iframe src="${url}" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true" class="w-100 h-100"></iframe>`;
  }

  // è©•ä¾¡é€ä¿¡ (Review)
  function sendReview(btn, rowIndex, isApproved) {
    // UI Immediate Feedback (Disable buttons in this group)
    const parent = btn.parentElement;
    const buttons = parent.querySelectorAll('button');
    buttons.forEach(b => b.disabled = true);

    const actionName = isApproved ? 'åˆæ ¼åˆ¤å®š' : 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯';

    // Call GAS
    runGoogleScript('reviewSubmission', [rowIndex, isApproved], function (result) {
      if (result.success) {
        // Show XP gain
        Swal.fire({
          title: 'è©•ä¾¡å®Œäº†ï¼',
          text: result.message, // "+10 XP" or "Daily Limit"
          icon: 'success',
          timer: 2000,
          showConfirmButton: false,
          toast: true,
          position: 'top-end'
        });

        // Reload gallery to show progress update? Or just leave it disabled.
        // Reloading might be too heavy. Just let user know it worked.
        // Ideally updates progress bar locally, but simpler to just disable for now.

      } else {
        Swal.fire('ã‚¨ãƒ©ãƒ¼', result.message, 'error');
        buttons.forEach(b => b.disabled = false); // Re-enable on error (except if "already reviewed")
      }
    }, function (e) {
      console.error(e);
      buttons.forEach(b => b.disabled = false);
    });
  }

  // GASé–¢æ•°å‘¼ã³å‡ºã—å…±é€šå‡¦ç†
  // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºæ©Ÿèƒ½
  function showToast(title, message, type = 'info') {
    const toastEl = document.getElementById('liveToast');
    const toastTitle = document.getElementById('toast-title');
    const toastBody = document.getElementById('toast-body');

    toastTitle.textContent = title;
    toastBody.textContent = message;

    // ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸè‰²å¤‰æ›´ãªã©ã¯å¿…è¦ãªã‚‰è¿½åŠ 

    const toast = new bootstrap.Toast(toastEl);
    toast.show();
  }

  // GASé–¢æ•°å‘¼ã³å‡ºã—å…±é€šå‡¦ç† (éåŒæœŸãƒ»éãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°)
  function runGoogleScript(funcName, args, onSuccess, onFailure, onFinally) {
    google.script.run
      .withSuccessHandler(function (result) {
        if (onSuccess) onSuccess(result);
        if (onFinally) onFinally();
      })
      .withFailureHandler(function (error) {
        console.error("GAS Error:", error);
        if (onFailure) {
          onFailure(error);
        } else {
          Swal.fire({
            title: 'ã‚¨ãƒ©ãƒ¼',
            text: 'é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message,
            icon: 'error',
            confirmButtonColor: '#e74c3c'
          });
        }
        if (onFinally) onFinally();
      })
    [funcName](...args);
  }
</script>