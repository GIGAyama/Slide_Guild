<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <?!= include('css'); ?>
</head>

<div class="container-fluid sticky-top p-0 bg-white shadow-sm">
  <!-- Header with Profile Badge -->
  <header class="d-flex justify-content-between align-items-center p-3 border-bottom">
    <div class="d-flex align-items-center">
      <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center text-white fw-bold me-2"
        style="width:40px; height:40px; font-size:1.2rem;" id="user-level-badge">1</div>
      <div class="lh-1">
        <div class="fw-bold text-dark small">Lv.<span id="user-level">1</span> <span id="user-xp"
            class="text-muted small fw-normal ms-1">(0 XP)</span></div>
        <div class="progress mt-1" style="height: 6px; width: 100px;">
          <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" id="xp-progress"></div>
        </div>
      </div>
    </div>
    <h5 class="m-0 fw-bold text-primary" style="font-family: 'Zen Maru Gothic', sans-serif;">
      <i class="bi bi-journal-album"></i> 冒険の書
    </h5>
  </header>

  <!-- Navigation -->
  <nav class="navbar navbar-expand custom-navbar py-1 border-bottom bg-light">
    <div class="container-fluid justify-content-center">
      <ul class="navbar-nav nav-pills w-100 justify-content-around">
        <li class="nav-item">
          <button class="nav-link active py-2 w-100 text-center rounded-0" onclick="switchView(this, 'quest-view')">
            <i class="bi bi-journal-bookmark-fill"></i> <ruby>冒険<rt>ぼうけん</rt></ruby>
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link py-2 w-100 text-center rounded-0" onclick="switchView(this, 'gallery-view')">
            <i class="bi bi-people-fill"></i> <ruby>広場<rt>ひろば</rt></ruby>
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link py-2 w-100 text-center rounded-0"
            onclick="switchView(this, 'mypage-view'); loadMyPage();">
            <i class="bi bi-person-circle"></i> <ruby>自分<rt>じぶん</rt></ruby>
          </button>
        </li>
      </ul>
    </div>
  </nav>
</div>

<!-- メインコンテンツ -->
<div class="container pb-5" style="margin-top: 20px;">

  <!-- 1. クエスト一覧 -->
  <div id="quest-view" class="view-section">
    <div class="text-center mb-4 section-header">
      <h5 class="fw-bold text-dark"><i class="bi bi-compass"></i> クエストを<ruby>選<rt>えら</rt></ruby>ぼう</h5>
    </div>
    <div id="quest-list"></div>
  </div>

  <!-- 2. ギャラリー -->
  <div id="gallery-view" class="view-section d-none">
    <div class="text-center mb-4 section-header">
      <h5 class="fw-bold text-dark"><i class="bi bi-collection-play"></i> みんなの<ruby>作品<rt>さくひん</rt></ruby></h5>

      <!-- Gallery Controls -->
      <div class="d-flex justify-content-center gap-2 mt-3">
        <select class="form-select w-auto" id="gallery-filter" onchange="loadGallery()">
          <option value="all">🌏 みんなの作品</option>
          <option value="unreviewed">🌱 応援・評価待ち</option>
          <option value="mine">👤 自分の作品</option>
        </select>
        <button class="btn btn-warning text-white rounded-circle" onclick="loadGallery()">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </div>
    </div>
    <div id="gallery-list" class="row g-4"></div>
  </div>

  <!-- 3. マイページ (NEW) -->
  <div id="mypage-view" class="view-section d-none">
    <div class="text-center mb-5">
      <div class="d-inline-block position-relative">
        <div
          class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center mx-auto shadow"
          style="width:120px; height:120px; font-size:3rem; font-weight:bold;" id="mypage-level">1</div>
        <span
          class="badge bg-primary position-absolute bottom-0 start-50 translate-middle-x rounded-pill px-3">LEVEL</span>
      </div>
      <h2 class="mt-3 fw-bold" id="mypage-user-id">User</h2>
      <p class="text-muted"><span id="mypage-xp">0</span> XP</p>

      <div class="progress mx-auto mt-3" style="width: 80%; height: 20px;">
        <div class="progress-bar bg-warning progress-bar-striped progress-bar-animated" role="progressbar"
          style="width: 0%" id="mypage-progress"></div>
      </div>
      <small class="text-muted">次のレベルまであと <span id="mypage-next-xp">100</span> XP</small>
    </div>

    <div class="card shadow-sm border-0 mb-4">
      <div class="card-header bg-white fw-bold"><i class="bi bi-trophy-fill text-warning"></i> クリアしたクエスト</div>
      <div class="card-body p-0">
        <ul class="list-group list-group-flush" id="mypage-cleared-list">
          <li class="list-group-item text-muted text-center py-4">まだクリアしていません</li>
        </ul>
      </div>
    </div>
  </div>

</div>

<!-- フッター -->
<footer class="text-center py-3 mt-4 border-top position-relative">
  <small class="text-muted">© 2026 Slide Guild <a href="https://note.com/cute_borage86" target="_blank"
      class="text-decoration-none text-warning">GIGA山</a></small>

  <!-- Teacher Menu Button (Bottom Right) -->
  <button class="btn btn-link text-muted position-absolute bottom-0 end-0 p-3 opacity-25 hover-opacity-100"
    onclick="openTeacherDashboard()">
    <i class="bi bi-gear-fill"></i>
  </button>
</footer>

<!-- Toast Container for Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto" id="toast-title">Notification</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toast-body">
      Hello, world!
    </div>
  </div>
</div>

<!-- Gallery Modal -->
<div class="modal fade" id="galleryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content" style="background: transparent; border: none;">
      <div class="modal-body p-0 position-relative">
        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-2 z-3"
          data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="ratio ratio-16x9 shadow-lg rounded overflow-hidden bg-black">
          <iframe id="gallery-iframe" src="" allowfullscreen="true" mozallowfullscreen="true"
            webkitallowfullscreen="true"></iframe>
        </div>
        <div class="text-center mt-3">
          <button class="btn btn-light rounded-pill fw-bold" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> 閉じる
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quest Detail Modal -->
<div class="modal fade" id="questDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-warning-subtle">
        <h5 class="modal-title fw-bold" id="quest-detail-title">クエスト詳細</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row h-100">
          <!-- Left: Info & Actions -->
          <div class="col-md-4 d-flex flex-column h-100">
            <div class="mb-3">
              <span class="badge bg-secondary rounded-pill mb-2" id="quest-detail-level">Lv.?</span>
              <div class="d-flex gap-1 flex-wrap" id="quest-detail-tags"></div>
            </div>
            <div class="card bg-light border-0 mb-3 flex-grow-1 overflow-auto">
              <div class="card-body">
                <h6 class="fw-bold text-muted"><i class="bi bi-info-circle"></i> クエストの内容</h6>
                <p class="card-text fs-5" id="quest-detail-desc" style="white-space: pre-wrap;"></p>
              </div>
            </div>
            <div class="d-grid gap-2 mt-auto" id="quest-detail-actions">
              <!-- Submit Button will be injected here -->
            </div>
          </div>
          <!-- Right: Guide Slide -->
          <div class="col-md-8 h-100">
            <div class="card h-100 border-0 shadow-sm bg-dark">
              <div class="card-header bg-dark text-white border-0 py-1">
                <small><i class="bi bi-person-video3"></i> お手本・ガイドスライド</small>
              </div>
              <div class="card-body p-0 position-relative bg-black" id="quest-detail-slide-container">
                <!-- iframe or placeholder -->
                <div class="position-absolute top-50 start-50 translate-middle text-center text-muted">
                  <i class="bi bi-file-earmark-slides" style="font-size: 3rem;"></i><br>
                  ガイドスライドなし
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Teacher Dashboard Modal -->
<div class="modal fade" id="teacherModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title"><i class="bi bi-speedometer2"></i> 先生用ダッシュボード</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs mb-3" id="teacherTab" role="tablist">
          <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-students">生徒一覧</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-import">クエスト取込</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-settings">設定</button>
          </li>
        </ul>
        <div class="tab-content">
          <!-- Students Tab -->
          <div class="tab-pane fade show active" id="tab-students">
            <div class="table-responsive" style="max-height: 400px; overflow-y:auto;">
              <table class="table table-striped table-hover small">
                <thead class="table-light sticky-top">
                  <tr>
                    <th>Email</th>
                    <th>Lv</th>
                    <th>XP</th>
                    <th>Clear</th>
                    <th>LastActive</th>
                  </tr>
                </thead>
                <tbody id="teacher-student-list"></tbody>
              </table>
            </div>
          </div>
          <!-- Import Tab -->
          <div class="tab-pane fade" id="tab-import">
            <div class="mb-3">
              <label class="form-label">クエストJSONデータ</label>
              <textarea class="form-control font-monospace" rows="10" id="quest-json-input"
                placeholder='[{"title":"...", ...}]'></textarea>
            </div>
            <button class="btn btn-primary" onclick="importQuests()"><i class="bi bi-cloud-upload"></i> インポート実行</button>
          </div>
          <!-- Settings Tab -->
          <div class="tab-pane fade" id="tab-settings">
            <div class="mb-3">
              <label class="form-label fw-bold">先生用パスワード変更</label>
              <input type="password" class="form-control mb-2" id="new-password" placeholder="新しいパスワード（4文字以上）"
                autocomplete="new-password">
              <button class="btn btn-danger" onclick="changePassword()"><i class="bi bi-key-fill"></i> パスワード変更</button>
            </div>
            <div class="alert alert-info small">
              <i class="bi bi-info-circle"></i> パスワードを忘れた場合は、`コード.gs` の `CONFIG` を直接確認・修正してください。
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<?!= include('js'); ?>
</body>

</html>